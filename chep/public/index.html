<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/styles.css">
    <script src="https://kit.fontawesome.com/cbcad42a26.js" crossorigin="anonymous"></script>
    <title>UID 결제 시스템</title>
</head>
<body>
    <div class="wrapper">
        <header class="headerBox">
            <button class="hamburger" onclick="clearDetectedObjects()">☰</button>
            <p>주문을 확인해주세요</p>
            <button class="addButton">+</button>
        </header>

        <section class="container">
            <div class="listInfo">
                <h4>상품명</h4>
                <h4>수량</h4>
                <h4>금액</h4>
            </div>
            <div class="inBox">
                <div id="detected-tags"></div>
                <!-- <div class="taglist"></div> -->
            </div>

                <!-- <div class="white-layout"> -->
                    <div class="totalBox">
                        <span>합계</span>
                        <span id="total-items">0개</span>
                        <span id="total-price">0원</span>
                    </div>

                    <div class="question"><span class="black-text">이 물건들이 </span><span class="red-text"> 맞으신가요?</span></div>

                    <div class="moneyBtnBox">
                        <button class="moneyBtn_cencle">
                            <div class="iconBox" style="margin-top: 10px">
                                <img src="./img/back.png" style="margin: 20px 0;" alt="결제취소" class="icon" style="margin-bottom: 8px">아니오
                            </div>
                        </button>
                        <button class="moneyBtn_fix" onclick="startPayment()">
                            <div class="iconBox">
                                <img src="./img/check_4.png" style="margin: 20px 0;" alt="결제진행" class="icon">예
                            </div>
                        </button>
                    </div>
                <!-- </div> -->
        </section>

        
        <div id="payment-popup" class="popup">
            <div class="popup-content">
                <div class="popup-title" id="popup-title">신용카드를 리더기에 대주세요.</div>
                <img src="./img/태깅4.gif" alt="Credit Card" class="popup-image" id="popup-image">
                <button class="popup-cancel" onclick="closePopup()">취소</button>
                <button class="popup-next" onclick="simulateTagging()">다음</button>
            </div>
        </div>

        <div id="overlay" class="overlay"></div>
    </div>
    <script>
        async function loadDetectedObjects() {
            try {
                const response = await fetch('/detected-objects');
                if (response.ok) {
                    const objects = await response.json();
                    displayDetectedObjects(objects);
                } else {
                    const errorMessage = await response.text();
                    displayStatus(`Failed to load detected objects: ${errorMessage}`, 'error');
                }
            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function clearDetectedObjects() {
            try {
                const response = await fetch('/clear-detected-objects', {
                    method: 'POST',
                });
                if (response.ok) {
                    loadDetectedObjects();  // 감지된 객체 목록을 다시 로드하여 화면을 업데이트
                } else {
                    const errorMessage = await response.text();
                    displayStatus(`Failed to clear detected objects: ${errorMessage}`, 'error');
                }
            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function startPayment() {
            const response = await fetch('/start-payment', { method: 'POST' });
            if (response.ok) {
                displayPopup();
            } else {
                const errorMessage = await response.text();
                displayStatus(`Failed to start payment: ${errorMessage}`, 'error');
            }
        }

        async function confirmPayment() {
            const response = await fetch('/confirm-payment', { method: 'POST' });
            if (response.ok) {
                const data = await response.json();
                displayStatus(data.message, 'success');
                closePopup();
            } else {
                const errorMessage = await response.text();
                displayStatus(`Failed to confirm payment: ${errorMessage}`, 'error');
            }
        }

        function displayDetectedObjects(objects) {
            const detectedTagsDiv = document.getElementById('detected-tags');
            detectedTagsDiv.innerHTML = '';  // 기존 목록을 비움
            let latestMessage = '';

            let totalItems = 0;
            let totalPrice = 0;

            objects.forEach(obj => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('detected-tag');
                const message = obj.message;
                const imagePath = `/public/img/${message.image}`; // 이미지 경로 수정
                let quantityImages = "";

                if (typeof message === 'object' && message.name && message.quantity && message.price && message.image) {
                    for (let i = 0; i < message.quantity; i++) {
                        quantityImages += `<img src="${imagePath}" alt="${message.name}" style="width: 30px; height: 30px;">`;
                    }
                    tagDiv.innerHTML = `<div class="product-name">${message.name}</div><div>${quantityImages}</div><div>${message.price}원</div>`;
                    totalItems += message.quantity;
                    totalPrice += message.quantity * message.price;
                } else {
                    tagDiv.innerHTML = `<div class="product-name">${message}</div><div></div><div></div>`;
                }
                detectedTagsDiv.appendChild(tagDiv);

                latestMessage = message.name || message;
            });

            document.getElementById('total-items').textContent = `${totalItems}개`;
            document.getElementById('total-price').textContent = `${totalPrice.toLocaleString()}원`;
        }

        function displayStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        function displayPopup() {
    const popup = document.getElementById('payment-popup');
    const overlay = document.getElementById('overlay');
    popup.style.display = 'block';
    overlay.style.display = 'block';
}

function closePopup() {
    const popup = document.getElementById('payment-popup');
    const overlay = document.getElementById('overlay');
    popup.style.display = 'none';
    overlay.style.display = 'none';
}

function simulateTagging() {
    const popupTitle = document.getElementById('popup-title');
    popupTitle.innerHTML = "결제 진행 중...";
    popupTitle.classList.remove('completed');
    popupTitle.classList.add('processing');
    document.getElementById('popup-image').src = "./img/dot.gif"; // 변경된 이미지
    document.querySelector('.popup-next').onclick = simulateConfirmation;
    document.querySelector('.popup-cancel').classList.remove('completed'); // 취소 버튼 위치 초기화
}

function simulateConfirmation() {
    const popupTitle = document.getElementById('popup-title');
    popupTitle.innerHTML = "결제가 완료되었습니다.<br>감사합니다.";
    popupTitle.classList.remove('processing');
    popupTitle.classList.add('completed');
    document.getElementById('popup-image').src = "./img/check.gif"; // 변경된 이미지
    document.querySelector('.popup-cancel').classList.add('completed'); // 취소 버튼 위치 조정
}

        const ws = new WebSocket('ws://' + window.location.host + '/ws');

        ws.onopen = function(event) {
            console.log('WebSocket connection opened');
        };

        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            console.log('Received WebSocket message:', message);

            const tagId = message.tagId;
            const now = new Date().getTime();
            const lastTaggedTime = lastTaggedTimes[tagId] || 0;

            if (now - lastTaggedTime > 3000) { // 3초 간격을 두고 태깅
                lastTaggedTimes[tagId] = now;
                loadDetectedObjects();
                if (message.message.includes('User card detected')) {
                    confirmPayment();
                }
            }
        };

        ws.onclose = function(event) {
            console.log('WebSocket connection closed, retrying in 3 seconds');
            setTimeout(function() {
                ws = new WebSocket('ws://' + window.location.host + '/ws');
            }, 3000);
        };

        window.onload = loadDetectedObjects;
    </script>
</body>
</html>
