<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/cbcad42a26.js" crossorigin="anonymous"></script>
    <title>UID ê²°ì œ ì‹œìŠ¤í…œ</title>
</head>
<body>
    <div class="wrapper">
        <header class="headerBox">
            <button class="hamburger" onclick="clearDetectedObjects()">â˜°</button>
            <p>ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</p>
            <button class="addButton">+</button>
        </header>

        <section class="container">
            <div class="listInfo">
                <h4>ìƒí’ˆëª…</h4>
                <h4>ìˆ˜ëŸ‰</h4>
                <h4>ê¸ˆì•¡</h4>
            </div>
            <div class="inBox">
            <!-- ì—¬ê¸°ë¶€ë¶„ -->
            <div id="detected-tags"></div>

            <h2 class="question"><span class="black-text">ìœ„ ëª©ë¡ì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ë¬¼ê±´ì´<br></span><span class="red-text">ë§ìŠµë‹ˆê¹Œ?</span></h2>

            <div class="totalBox">
                <span>í•©ê³„</span>
                <span id="total-items">0ê°œ</span>
                <span id="total-price">0ì›</span>
            </div>
            </div>

            <div class="moneyBtnBox">
                <button class="moneyBtn_cencle">
                    <div class="iconBox" style="margin-top: 10px">
                        <img src="img/back.png" style="margin: 20px 0;" alt="ê²°ì œì·¨ì†Œ" class="icon" style="margin-bottom: 8px">ê²°ì œ ì·¨ì†Œ
                    </div>
                </button>
                <button class="moneyBtn_fix" onclick="startPayment()">
                    <div class="iconBox">
                        <img src="img/check_4.png" style="margin: 20px 0;" alt="ê²°ì œì§„í–‰" class="icon">ê²°ì œ ì§„í–‰
                    </div>
                </button>
            </div>
        </section>
    </div>

    <script>
        async function loadDetectedObjects() {
            try {
                const response = await fetch('/detected-objects');
                if (response.ok) {
                    const objects = await response.json();
                    displayDetectedObjects(objects);
                } else {
                    const errorMessage = await response.text();
                    displayStatus(`Failed to load detected objects: ${errorMessage}`, 'error');
                }
            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function clearDetectedObjects() {
            try {
                const response = await fetch('/clear-detected-objects', {
                    method: 'POST',
                });
                if (response.ok) {
                    loadDetectedObjects();  // ê°ì§€ëœ ê°ì²´ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ í™”ë©´ì„ ì—…ë°ì´íŠ¸
                } else {
                    const errorMessage = await response.text();
                    displayStatus(`Failed to clear detected objects: ${errorMessage}`, 'error');
                }
            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function startPayment() {
            const response = await fetch('/start-payment', { method: 'POST' });
            if (response.ok) {
                displayPopup();
            } else {
                const errorMessage = await response.text();
                displayStatus(`Failed to start payment: ${errorMessage}`, 'error');
            }
        }

        async function confirmPayment() {
            const response = await fetch('/confirm-payment', { method: 'POST' });
            if (response.ok) {
                const data = await response.json();
                displayStatus(data.message, 'success');
                closePopup();
            } else {
                const errorMessage = await response.text();
                displayStatus(`Failed to confirm payment: ${errorMessage}`, 'error');
            }
        }

        function displayDetectedObjects(objects) {
            const detectedTagsDiv = document.getElementById('detected-tags');
            detectedTagsDiv.innerHTML = '';  // ê¸°ì¡´ ëª©ë¡ì„ ë¹„ì›€
            let latestMessage = '';

            let totalItems = 0;
            let totalPrice = 0;

            objects.forEach(obj => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('detected-tag');
                const message = obj.message;
                const emoji = "ğŸ"; // ì˜ˆì‹œ ì´ëª¨í‹°ì½˜, ì›í•˜ëŠ” ì´ëª¨í‹°ì½˜ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥
                let quantityEmojis = "";

                if (typeof message === 'object' && message.name && message.quantity && message.price) {
                    for (let i = 0; i < message.quantity; i++) {
                        quantityEmojis += emoji;
                    }
                    tagDiv.innerHTML = `<div class="product-name">${message.name}</div><div>${quantityEmojis}</div><div>${message.price}ì›</div>`;
                    totalItems += message.quantity;
                    totalPrice += message.quantity * message.price;
                } else {
                    tagDiv.innerHTML = `<div class="product-name">${message}</div><div></div><div></div>`;
                }
                detectedTagsDiv.appendChild(tagDiv);

                latestMessage = message.name || message;
            });

            document.getElementById('total-items').textContent = `${totalItems}ê°œ`;
            document.getElementById('total-price').textContent = `${totalPrice.toLocaleString()}ì›`;

            if (latestMessage.includes('User card detected')) {
                userInfo.style.display = 'block';
                adminInfo.style.display = 'none';
                info.className = 'info user';
                info.innerHTML = '<strong>ë§¤ì¥ ê³ ê°ì…ë‹ˆë‹¤.</strong>';
                const balanceMatch = latestMessage.match(/(\d+)ì› ê²°ì œìš© ì¹´ë“œ/);
                if (balanceMatch) {
                    userBalance.textContent = `${balanceMatch[1]}ì›`;
                }
            } else if (latestMessage.includes('Admin card detected')) {
                adminInfo.style.display = 'block';
                userInfo.style.display = 'none';
                info.className = 'info admin';
                info.innerHTML = '<strong>ê´€ë¦¬ìì…ë‹ˆë‹¤.</strong>';
                adminDetails.innerHTML = `ê´€ë¦¬ìëª…: ${objects[objects.length - 1].info.ê´€ë¦¬ìëª…}<br>ì—°ë½ì²˜: ${objects[objects.length - 1].info.ì—°ë½ì²˜}<br>ì„œë¹„ìŠ¤êµ¬ë¶„: ${objects[objects.length - 1].info.ì„œë¹„ìŠ¤êµ¬ë¶„}<br>ì§€ì ëª…: ${objects[objects.length - 1].info.ì§€ì ëª…}<br>ì£¼ì†Œ: ${objects[objects.length - 1].info.ì£¼ì†Œ}`;
            } else if (latestMessage.includes('purchased for')) {
                info.className = 'info success';
                info.innerHTML = `<strong>${latestMessage}</strong>`;
            } else if (latestMessage.includes('Insufficient balance')) {
                info.className = 'info error';
                info.innerHTML = '<strong>ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</strong>';
            } else {
                userInfo.style.display = 'none';
                adminInfo.style.display = 'none';
                info.className = 'info';
                info.textContent = '';
            }
        }

        function displayStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function displayPopup() {
            const popup = document.getElementById('payment-popup');
            popup.style.display = 'block';
        }

        function closePopup() {
            const popup = document.getElementById('payment-popup');
            popup.style.display = 'none';
        }

        const ws = new WebSocket('ws://' + window.location.host + '/ws');

        ws.onopen = function(event) {
            console.log('WebSocket connection opened');
        };

        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            console.log('Received WebSocket message:', message);

            const tagId = message.tagId;
            const now = new Date().getTime();
            const lastTaggedTime = lastTaggedTimes[tagId] || 0;

            if (now - lastTaggedTime > 3000) { // 3ì´ˆ ê°„ê²©ì„ ë‘ê³  íƒœê¹…
                lastTaggedTimes[tagId] = now;
                loadDetectedObjects();
                if (message.message.includes('User card detected')) {
                    confirmPayment();
                }
            }
        };

        ws.onclose = function(event) {
            console.log('WebSocket connection closed, retrying in 3 seconds');
            setTimeout(function() {
                ws = new WebSocket('ws://' + window.location.host + '/ws');
            }, 3000);
        };

        window.onload = loadDetectedObjects;
    </script>
</body>
</html>
