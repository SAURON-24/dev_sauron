<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/cbcad42a26.js" crossorigin="anonymous"></script>
    <title>UID 결제 시스템</title>
</head>
<body>
    <header class="headerBox">
        <button class="hamburger">☰</button>
        <p>주문 내역 확인</p>
        <button class="addButton">+</button>
    </header>

    <section class="container">
        <div class="listInfo">
            <h4>상품명</h4>
            <h4>수량</h4>
            <h4>금액</h4>
        </div>

        <!-- 여기부분 -->
        <div id="detected-tags"></div>

        <h2 class="question"><span class="black-text">위 목록이 장바구니에 담긴 물건이<br></span><span class="red-text">맞습니까?</span></h2>
        <div class="moneyBtnBox">
            <button class="moneyBtn_cencle"><div class="iconBox" style="margin-top: 10px"><img src="img/back.png" alt="결제취소" class="icon"  style="margin-bottom: 8px">결제 취소</div></button>
            <button class="moneyBtn_fix" onclick="startPayment()"><div class="iconBox"><img src="img/check_4.png" alt="결제진행" class="icon">결제 진행</div></button>
        </div>
        <!-- <div id="status" class="status"></div> -->

        <!-- <div id="info" class="info"></div> -->

        <div class="user-info" id="user-info">
            <h2>유저 카드 정보</h2>
            <p>충전금액: <span id="user-balance"></span></p>
        </div>

        <div class="admin-info" id="admin-info">
            <h2>관리자 정보</h2>
            <p id="admin-details"></p>
        </div>

        <button onclick="clearDetectedObjects()">리스트 삭제</button>
    </section>

    <div id="payment-popup" class="popup">
        <h2>카드를 투입구에 터치해주세요</h2>
    </div>

    <script>
        async function loadDetectedObjects() {
            try {
                const response = await fetch('/detected-objects');
                if (response.ok) {
                    const objects = await response.json();
                    displayDetectedObjects(objects);
                } else {
                    const errorMessage = await response.text();
                    displayStatus(`Failed to load detected objects: ${errorMessage}`, 'error');
                }
            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
            }
        }
    
        async function clearDetectedObjects() {
            try {
                const response = await fetch('/clear-detected-objects', {
                    method: 'POST',
                });
                if (response.ok) {
                    loadDetectedObjects();  // 감지된 객체 목록을 다시 로드하여 화면을 업데이트
                } else {
                    const errorMessage = await response.text();
                    displayStatus(`Failed to clear detected objects: ${errorMessage}`, 'error');
                }
            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
            }
        }
    
        async function startPayment() {
            const response = await fetch('/start-payment', { method: 'POST' });
            if (response.ok) {
                displayPopup();
            } else {
                const errorMessage = await response.text();
                displayStatus(`Failed to start payment: ${errorMessage}`, 'error');
            }
        }
    
        async function confirmPayment() {
            const response = await fetch('/confirm-payment', { method: 'POST' });
            if (response.ok) {
                const data = await response.json();
                displayStatus(data.message, 'success');
                closePopup();
            } else {
                const errorMessage = await response.text();
                displayStatus(`Failed to confirm payment: ${errorMessage}`, 'error');
            }
        }
    
        function displayDetectedObjects(objects) {
            const detectedTagsDiv = document.getElementById('detected-tags');
            const userInfo = document.getElementById('user-info');
            const adminInfo = document.getElementById('admin-info');
            const info = document.getElementById('info');
            const userBalance = document.getElementById('user-balance');
            const adminDetails = document.getElementById('admin-details');
        
            detectedTagsDiv.innerHTML = '';  // 기존 목록을 비움
            let latestMessage = '';
    
            objects.forEach(obj => {
                const tagDiv = document.createElement('div');
                const message = obj.message;
                if (typeof message === 'object' && message.name && message.quantity && message.price) {
                    tagDiv.innerHTML = `<p>${message.name}</p><p>${message.quantity}</p><p>${message.price}원</p>`;
                } else {
                    tagDiv.innerHTML = `<p>${message}</p>`;
                }
                detectedTagsDiv.appendChild(tagDiv);
    
                latestMessage = message.name || message;
            });
    
            if (latestMessage.includes('User card detected')) {
                userInfo.style.display = 'block';
                adminInfo.style.display = 'none';
                info.className = 'info user';
                info.innerHTML = '<strong>매장 고객입니다.</strong>';
                const balanceMatch = latestMessage.match(/(\d+)원 결제용 카드/);
                if (balanceMatch) {
                    userBalance.textContent = `${balanceMatch[1]}원`;
                }
            } else if (latestMessage.includes('Admin card detected')) {
                adminInfo.style.display = 'block';
                userInfo.style.display = 'none';
                info.className = 'info admin';
                info.innerHTML = '<strong>관리자입니다.</strong>';
                adminDetails.innerHTML = `관리자명: ${objects[objects.length - 1].info.관리자명}<br>연락처: ${objects[objects.length - 1].info.연락처}<br>서비스구분: ${objects[objects.length - 1].info.서비스구분}<br>지점명: ${objects[objects.length - 1].info.지점명}<br>주소: ${objects[objects.length - 1].info.주소}`;
            } else if (latestMessage.includes('purchased for')) {
                info.className = 'info success';
                info.innerHTML = `<strong>${latestMessage}</strong>`;
            } else if (latestMessage.includes('Insufficient balance')) {
                info.className = 'info error';
                info.innerHTML = '<strong>잔액이 부족합니다.</strong>';
            } else {
                userInfo.style.display = 'none';
                adminInfo.style.display = 'none';
                info.className = 'info';
                info.textContent = '';
            }
        }
    
        function displayStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
    
        function displayPopup() {
            const popup = document.getElementById('payment-popup');
            popup.style.display = 'block';
        }
    
        function closePopup() {
            const popup = document.getElementById('payment-popup');
            popup.style.display = 'none';
        }
    
        const ws = new WebSocket('ws://' + window.location.host + '/ws');
    
        ws.onopen = function(event) {
            console.log('WebSocket connection opened');
        };
    
        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            console.log('Received WebSocket message:', message);
    
            const tagId = message.tagId;
            const now = new Date().getTime();
            const lastTaggedTime = lastTaggedTimes[tagId] || 0;
    
            if (now - lastTaggedTime > 3000) { // 3초 간격을 두고 태깅
                lastTaggedTimes[tagId] = now;
                loadDetectedObjects();
                if (message.message.includes('User card detected')) {
                    confirmPayment();
                }
            }
        };
    
        ws.onclose = function(event) {
            console.log('WebSocket connection closed, retrying in 3 seconds');
            setTimeout(function() {
                ws = new WebSocket('ws://' + window.location.host + '/ws');
            }, 3000);
        };
    
        window.onload = loadDetectedObjects;
    </script>
    
</body>
</html>
